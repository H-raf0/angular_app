<main class="dashboard-main">
  <div class="header-container">
    <h1 i18n>Stock Dashboard</h1>
    <div class="header-right">
      <span class="balance" i18n>Balance: ${{ portfolio?.balance | number: '1.2-2' }}</span>
      <button type="button" class="btn btn-primary" i18n (click)="openAddMoneyDialog()">
        + Add Money
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Top Companies List (stacked above content) -->
    <div class="sidebar">
      <div class="card">
        <div class="card-header">
          <h3 i18n>Companies</h3>
        </div>
        <div class="card-body">
          <label for="companies-select" class="visually-hidden">Companies</label>
          <select
            id="companies-select"
            class="companies-select"
            [(ngModel)]="selectedStockId"
            (ngModelChange)="onSelectById($event)"
          >
            <option [ngValue]="null">-- Select a company --</option>
            <option *ngFor="let stock of stocks; trackBy: trackByStockId" [ngValue]="stock.id">
              {{ stock.symbol }} â€” {{ stock.name }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Main Content: Stock Details (below the companies list) -->
    <div class="main-content" style="width:100%;">
      @if (selectedStock) {
        <div class="card">
          <div class="card-header">
            <div class="stock-header">
              <div>
                <h2 i18n>{{ selectedStock.name }} ({{ selectedStock.symbol }})</h2>
                <p class="price" i18n>Price: ${{ selectedStock.price | number: '1.2-2' }}</p>
                <p
                  class="change"
                  [class.positive]="selectedStock.change >= 0"
                  [class.negative]="selectedStock.change < 0"
                >
                  {{ selectedStock.change >= 0 ? '+' : '' }}{{ selectedStock.change }}%
                </p>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Simple SVG Line Chart -->
            <div class="chart-container">
              <svg width="100%" height="420" viewBox="0 0 750 420" preserveAspectRatio="xMidYMid meet">
                
                <!-- Y-axis line -->
                <line
                  x1="40"
                  y1="30"
                  x2="40"
                  y2="390"
                  stroke="currentColor"
                  stroke-width="1"
                  opacity="0.3"
                />
                
                <!-- X-axis line -->
                <line
                  x1="40"
                  y1="390"
                  x2="650"
                  y2="390"
                  stroke="currentColor"
                  stroke-width="1"
                  opacity="0.3"
                />

                <!-- Grid lines and Y-axis labels -->
                <g class="grid-lines">
                  <ng-container *ngFor="let t of getYTicks(selectedStock.priceHistory)">
                    <!-- Dotted grid line -->
                    <line 
                      x1="40" 
                      x2="650" 
                      [attr.y1]="t.y" 
                      [attr.y2]="t.y" 
                      stroke="rgba(255,255,255,0.03)" 
                      stroke-width="1" 
                      stroke-dasharray="4"
                    />
                    <!-- Price Text: Centered vertically on line using dy="0.32em" -->
                    <text class="y-label" [attr.x]="10" [attr.y]="t.y" dy="0.32em">{{ t.label }}</text>
                  </ng-container>
                </g>

                <!-- Candlestick Rendering -->
                <g *ngFor="let c of getCandles(selectedStock.priceHistory); trackBy: trackByPointIndex">
                  <!-- Wick -->
                  <line
                    [attr.x1]="c.x"
                    [attr.x2]="c.x"
                    [attr.y1]="c.highY"
                    [attr.y2]="c.lowY"
                    [attr.stroke]="c.color === 'buy' ? 'var(--chart-buy)' : 'var(--chart-sell)'"
                    stroke-width="1.5"
                    stroke-linecap="round"
                  />
                  <!-- Body -->
                  <rect
                    [attr.x]="c.x - c.width / 2"
                    [attr.width]="c.width"
                    [attr.y]="c.bodyY"
                    [attr.height]="c.bodyHeight"
                    [attr.fill]="c.color === 'buy' ? 'var(--chart-buy)' : 'var(--chart-sell)'"
                  />
                </g>

                <!-- X-axis labels -->
                <g class="x-labels">
                  <ng-container *ngFor="let t of getXTicks(selectedStock.priceHistory)">
                    <text class="x-label" [attr.x]="t.x" [attr.y]="410" text-anchor="middle">{{ t.label }}</text>
                  </ng-container>
                </g>
              </svg>
            </div>

            <!-- Buy Stock Section -->
            <div class="buy-section">
              <div class="quantity-input">
                <label for="quantity" i18n>Quantity:</label>
                <input
                  id="quantity"
                  type="number"
                  min="1"
                  class="input-field"
                  [(ngModel)]="buyQuantity"
                />
              </div>
              <p class="total-cost" i18n>
                Total Cost: ${{ selectedStock.price * buyQuantity | number: '1.2-2' }}
              </p>
              <button
                type="button"
                class="btn btn-primary"
                i18n
                [disabled]="
                  buyQuantity <= 0 || selectedStock.price * buyQuantity > (portfolio?.balance || 0)
                "
                (click)="buyStock(selectedStock)"
              >
                ðŸ›’ Buy
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                i18n
                [disabled]="!canSell()"
                (click)="sellStock(selectedStock)"
              >
                ðŸ’¸ Sell
              </button>
            </div>

            <!-- Portfolio Holdings -->
            @if (portfolio && portfolio.stocks[selectedStock.symbol]) {
              <div class="holdings">
                <h4 i18n>Your Holdings</h4>
                <p i18n>
                  You own {{ portfolio.stocks[selectedStock.symbol] }} shares worth ${{
                    selectedStock.price * portfolio.stocks[selectedStock.symbol] | number: '1.2-2'
                  }}
                </p>
              </div>
            }
          </div>
        </div>
      } @else {
        <div class="card">
          <div class="card-body">
            <p class="empty-state" i18n>Select a company from the list to view details</p>
          </div>
        </div>
      }
    </div>
  </div>
</main>